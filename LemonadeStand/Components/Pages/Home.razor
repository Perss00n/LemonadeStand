@page "/"
@rendermode InteractiveServer

@using LemonadeStand.Application.Interfaces
@using LemonadeStand.Application.DTOs
@using LemonadeStand.Domain.Models
@using LemonadeStand.Domain.Interfaces

@inject IFruitPressService FruitPressService

<PageTitle>Lemonade Stand 1.0</PageTitle>

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8 col-xl-7">

<h3 class="mb-4">🍋 Lemonade Stand</h3>

            <h5 class="mb-3">Available recipes</h5>

            <div class="row g-3 mb-4">

                <div class="col-md-4">
                    <div class="card h-100 shadow-sm">
                        <div class="card-body text-center">
                            <h6 class="card-title">🍎 Apple Lemonade</h6>
                            <p class="mb-1"><strong>Price per glass:</strong> 10</p>
                            <p class="mb-0 text-muted small">Fruits needed: 2 Apple(s)</p>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="card h-100 shadow-sm">
                        <div class="card-body text-center">
                            <h6 class="card-title">🍊 Orange Lemonade</h6>
                            <p class="mb-1"><strong>Price per glass:</strong> 15</p>
                            <p class="mb-0 text-muted small">Fruits needed: 2 Orange(s)</p>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="card h-100 shadow-sm">
                        <div class="card-body text-center">
                            <h6 class="card-title">🍈 Melon Lemonade</h6>
                            <p class="mb-1"><strong>Price per glass:</strong> 20</p>
                            <p class="mb-0 text-muted small">Fruits needed: 3 Melon(s)</p>
                        </div>
                    </div>
                </div>

            </div>

<div class="card shadow-sm">
    <div class="card-body">

   <h5 class="card-title mb-3">Place order</h5>

        <div class="row g-3">

            <div class="col-md-6">
                <label class="form-label">Recipe</label>
                <select class="form-select" @bind="selectedRecipe">
                    <option value="Apple">Apple Juice</option>
                    <option value="Orange">Orange Juice</option>
                    <option value="Melon">Melon Juice</option>
                </select>
            </div>

            <div class="col-md-6">
                <label class="form-label">Ordered glasses</label>
                <input type="number" class="form-control" min="1" @bind="orderedGlasses" />
            </div>

            <div class="col-md-6">
                <label class="form-label">Money paid</label>
                <input type="number" class="form-control" min="0" @bind="moneyPaid" />
            </div>

            <div class="col-md-6">
                <label class="form-label">Fruits provided</label>
                <input type="number" class="form-control" min="0" @bind="fruitCount" />
            </div>

        </div>

        <div class="mt-4">
            <button class="btn btn-primary w-100" @onclick="Produce">
                Produce 🍹
            </button>
        </div>
    </div>
</div>

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger mt-4">

                    <h5 class="alert-heading">
                        <i class="bi bi-exclamation-triangle-fill text-danger"></i>
                        <span> Operation Failed</span>
                    </h5>

                    <strong>Error:</strong> @errorMessage
                </div>
            }


            @if (result is not null)
            {
                <div class="mt-4 alert @(result.Success ? "alert-success" : "alert-danger")">
                    <h5 class="alert-heading">
                        @if (result.Success)
                        {
                            <i class="bi bi-check-circle-fill text-success"></i>
                            <span> Success</span>
                        }
                        else
                        {
                            <i class="bi bi-x-circle-fill text-danger"></i>
                            <span> Failed</span>
                        }
                    </h5>

                    <p>@result.Message</p>

                    <hr />

                    <ul class="mb-0">
                        <li><strong>Produced glasses:</strong> @result.ProducedGlasses</li>
                        <li><strong>Fruits used:</strong> @result.FruitsUsed</li>
                        <li><strong>Change:</strong> @result.Change</li>
                        <li><strong>Remaining fruits:</strong> @result.RemainingFruits.Count</li>
                    </ul>
                </div>
            }

        </div>
    </div>
</div>

@code {
    private string selectedRecipe = "Apple";
    private int orderedGlasses = 1;
    private int moneyPaid;
    private int fruitCount;
    private string? errorMessage;

    private FruitPressResult? result;

    private void Produce()
    {
        errorMessage = null;

        try
        {
            var recipe = selectedRecipe switch
            {
                "Apple" => new Recipe("Apple Juice", typeof(Apple), 2, 10),
                "Orange" => new Recipe("Orange Juice", typeof(Orange), 2, 15),
                "Melon" => new Recipe("Melon Juice", typeof(Melon), 3, 20),
                _ => throw new InvalidOperationException()
            };

            var fruits = new List<IFruit>();

            for (int i = 0; i < fruitCount; i++)
            {
                fruits.Add(selectedRecipe switch
                {
                    "Apple" => new Apple(),
                    "Orange" => new Orange(),
                    "Melon" => new Melon(),
                    _ => throw new InvalidOperationException()
                });
            }

            result = FruitPressService.Produce(
                recipe,
                fruits,
                moneyPaid,
                orderedGlasses
            );
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
            result = null;
        }
    }

}